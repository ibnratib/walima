{% extends "general/base.html" %}
{% load i18n %}

{% block body %}

<h1 class="h3 mb-3"><strong>Nouveau</strong> mot de passe</h1>


      <div class="col-12 col-lg-4 col-md-12">
        <div id="pharmacy-form" class="card">
          <div class="card-body">
                    {% if validlink %}
                            {% if form.errors %}
                                <div class="error_message" style="margin-bottom:0px;">
                                        {% for key, value in form.errors.items %}
                                            {{ value }}
                                        {% endfor %}
                                </div>
                            {% endif %}
                            <div class="card-body">
                                <form method="POST">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label class="form-label" for="id_new_password1">Nouveau mot de passe</label>
                                        <input type="password" name="new_password1" autocomplete="new-password"
                                               class="form-control" required id="id_new_password1"/>
                                    </div>
                                    <div class="mb-3">
                                    <div class="progress">
                                      <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    </div>
                                    <div class="mb-3">
                                     <div class=" form-control">
                                          <b>Votre mot de passe doit contenir :</b>
                                          <ul style="margin-top:5px; margin-bottom:0px;" >
                                              <li>
                                                Au moins 8 caractères
                                              </li>
                                              <li>
                                                Au moins 1 chiffre
                                              </li>
                                              <li>
                                                Au moins 1 minuscule
                                              </li>
                                              <li>
                                               Au moins 1 majuscule
                                              </li>
                                            </ul>
                                      </div>
                                      </div>
                    <div class="mb-3">
                     <div id='message-matching'></div>
                    </div>
                                    <div class="mb-3">
                                        <label class="form-label" for="id_new_password2">Confirmer le mot de passe</label>
                                        <input type="password" name="new_password2" autocomplete="new-password"
                                                       required id="id_new_password2" class="form-control"/>
                                    </div>
                                    <button id="ajax_button" type="submit" disabled class="btn btn-success btn-block btn-lg"> <i class="align-middle" data-feather="check"></i> Confirmer</button>
                                </form>
                            </div>
                        </div>
                    {% else %}
                    <div class="alert alert-warning">
                        Le lien de réinitialisation du mot de passe n'est pas valide, peut-être parce qu'il a déjà été utilisé. Veuillez demander une nouvelle réinitialisation de mot de passe.
                    </div>
                    {% endif %}
        </div>
      </div>
               {% block js %}
                {{ form.media }}
              {% endblock %}
<script>

$(".password_strength_info").html("")

var identical_password=0;
var valid_password=0;

function enable_disable_button()
{
    if (identical_password + valid_password == 2)
    {
                 $('#ajax_button').attr("disabled", false);
                 $("#ajax_button").css("background","#28c194")
                 $("#ajax_button").css("border","green")
    }else
    {
                $('#ajax_button').attr("disabled", true);
                 $("#ajax_button").css("background","grey")
                 $("#ajax_button").css("border","black")
    }
}


$( "#id_new_password1").on( "keyup", function() {


        data_dict={"pw":$(this).val()}

        $.ajax({
            headers: { "X-CSRFToken": getCookie("csrftoken") },
            type: 'POST',
            processData: false,
            contentType: false,
            url: "{% url 'score_pw' %}",
            data : JSON.stringify(data_dict),
            success: function (response) {
            console.log(response['score'])
            var bar_width = parseInt(response['score'])*25
            var color="";
            if (bar_width <50)
                {
                    color="#d9534f";   
                }else if (bar_width ==50)
                {
                    color="#f0ad4e";
                }else if (bar_width >50)
                {
                    color="#5cb85c";
                }
            $(".progress-bar").css("width",bar_width+"%")
            $(".progress-bar").css("background",color)
            if(response['score'] > 2)
            {
                 valid_password = 1;
            }
            else
            {
                 valid_password = 0;
            }
            }
        })

        enable_disable_button();
});


$('#id_new_password1, #id_new_password2').on('keyup', function () {

  if ($('#id_new_password1').val() == $('#id_new_password2').val() && $('#id_new_password1').val() != "") {
    $('#message-matching').html('<div class="success_message">Les mots de passe sont identiques</div>');
    identical_password =1;
  } else
  {
    if ($('#id_new_password2').val() != "")
    {
        $('#message-matching').html('<div class="error_message">Les mots de passe ne sont pas identiques</div>');
        identical_password =0;
    }else
    {
        $('#message-matching').html('');
        identical_password =0;
    }
  }
 enable_disable_button();
});


function getCookie(c_name)
{
    if (document.cookie.length > 0)
    {
        c_start = document.cookie.indexOf(c_name + "=");
        if (c_start != -1)
        {
            c_start = c_start + c_name.length + 1;
            c_end = document.cookie.indexOf(";", c_start);
            if (c_end == -1) c_end = document.cookie.length;
            return unescape(document.cookie.substring(c_start,c_end));
        }
    }
    return "";
 }


</script>

{% endblock %}













